---
title: "Hands-on Practical: Linear Regression"
author: "René Gier Vemmelund"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    self_contained: yes
    toc: true
    toc_depth: 3

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
# Suggested packages for this practical (ggplot2-only plotting)
# install.packages(c("AED", "ggplot2", "GGally", "broom", "dplyr"))
library(tidyverse)
library(ggplot2)
library(dplyr)
library(broom)
library(GGally)   # for ggpairs (ggplot2-based pairplot)
# Let's read the data right way 
Nereis <- read_table("DATA/Nereis.txt")
```


## Learning goals

-   Distinguish correlation vs regression
-   Build and interpret simple and multiple linear models
-   Understand components, assumptions, diagnostics, and partial residuals
-   Practice model simplification and reflect on uses & limitations

## Timeline (2 hours)

| **Time** | **Activity**. |
|----------------------|-------------------------------------------------|
| 0:00–0:20 | ggplot2 EDA: Cleveland (overall & by nutrient), box-plot, (ggpairs) |
| 0:20–0:35 | Correlation vs regression; fit & plot simple LM |
| 0:35–0:55 | Simple LM interpretation |
| 0:55–1:15 | Multiple LM with factor; overlay lines |
| 1:15–1:35 | ggplot2 diagnostics (residuals–fitted, QQ, scale–location) |
| 1:35–1:55 | Partial residual plots (numeric + factor) |
| 1:55–2:00 | Model simplification & limitations |

## The data-set (5 min)

The Nereis data-set is a classic example from marine benthic ecology, used to illustrate linear modelling approaches in R. It originates from experiments examining the role of the deposit-feeding polychaete *Hediste (Nereis) diversicolor* in nutrient generation in marine sediments.

The data-set contains three variables:

-   **`concentration`** – measured nutrient concentration (response variable).
-   **`biomass`** – biomass of Nereis diversicolor (continuous predictor).
-   **`nutrient`** – nutrient type (categorical factor with three levels: NH~4~-N, PO~4~-P, NO~3~-N).

The experimental question was whether nutrient concentrations could be explained by the biomass of *Nereis diversicolor* and by nutrient type. It is widely used for teaching because it demonstrates how to build and interpret regression models that include both continuous and categorical predictors, while also highlighting issues such as heterogeneity of variance across groups.

::: {.alert .alert-info}
**Task: Load The data**

*Step 1*: Load the Data set Read the data using the correct delimiter (here, tab-delimited):

**Hint** you cloud use either the `read.table()`, `read_delim()`, or `read_table()` functions

*Step 2*: Check Your Data Preview and summarise your data:

**Hint**: To quickly explore your data, use `head()` to view the first few rows, `str()` to check the structure, and `summary()` to get an overview of each variable in the table.
:::

```{r}
## Load the Dataset Read the data using the correct delimiter (here, tab-delimited): 
Nereis <- read_delim("DATA/Nereis.txt",
                          delim = "\t",
                          col_names = TRUE,
                          na = c("", "NA")
                          )
Nereis

## Check Your Data Preview and summarise your data:
head(Nereis)      # Shows the first few rows
str(Nereis)       # Shows the structure
summary(Nereis)   # Gives summary statistics


```

::: {.alert .alert-success}
**Question**

1.  Describe the Dataset?

    [The dataset contains 45 observation and 3 variables: *concentration* (numeric), *biomass* (numeric) and *nutrient* (factor).
    The range of *concentration* is 0.050 and 3.825, and it has a median of 1.050. For *biomass* this is 0, 2 and 1.
    For *nutrient* this 1, 3 and 2.]{.underline}
:::

------------------------------------------------------------------------

## Data exploration with ggplot2 (20 min)

### Cleveland dotplot (overall)

::: {.alert .alert-info}
**Task: Cleveland dotplot**


Recreate a Cleveland dotplot of concentration (each point = one observation). A **Cleveland dotplot** places a dot for each observation along a numerical scale, usually the x-axis, with the order of cases (observations) along the y-axis. It Helps detect outliers (extremely high or low points), and is useful for comparing variation across categories.

**Hint**: create a row index and plot concentration vs index using `geom_point()` and `coord_flip()`.
:::

```{r}
### Create a variable named obs that has the row number for a observation
Nereis <- Nereis |> arrange(concentration) |>mutate(obs = row_number())
### Make the Cleveland dotplot
ggplot(Nereis, aes(x = obs, y = concentration )) +
geom_point() +
   #coord_flip() +
   labs(x = "Order of observations", y = "Concentration",
        title = "Cleveland dotplot (ggplot2)") +
   theme_bw()
```

### Cleveland dotplot grouped by nutrient

::: {.alert .alert-info}
**Task: Cleveland dotplot grouped by **

Group by nutrient (as factor), facet by nutrient, and use `geom_point()`.
:::

```{r}
### Turn the variable nutrient into a factor
Nereis <- Nereis |> mutate(nutrient = as.factor(nutrient))
### Make the Cleveland dotplot
 ggplot(Nereis, aes(x = obs , y = concentration)) +
   geom_point(aes(shape = nutrient)) +
   coord_flip() +
   facet_wrap(~ nutrient,
              scales = "free_y") +
   labs(x = "Order of observations", y = "Concentration",
        title = "Cleveland dotplot by nutrient") +
   theme_bw()
```

### Box-plot of concentration by nutrient

::: {.alert .alert-info}
**Task: Box-plot of concentration by nutrient**

Make a box-plot for concentration by nutrient

:::
```{r}
ggplot(Nereis, aes(x = nutrient, y = concentration )) +
  geom_boxplot(width = 0.7) +
  labs(x = "Nutrient", y = "Concentration",
       title = "Boxplot of concentration by nutrient") +
  theme_bw()
```

### Pair-plot (ggplot2-based)

::: {.alert .alert-info}
**Task: Pair-plot**

Use `GGally::ggpairs` (built on `ggplot2`) to visualize bivariate relations. This exploration focus on assessing possible heterogeneity among nutrients and presence/absence of outliers.

:::

```{r}
GGally::ggpairs(
  Nereis |> select( concentration , #concentration
                    biomass , #biomass
                    nutrient ),#nutrient
  mapping = aes(colour = nutrient,
                alpha = 0.5),
  columns = 1:3)
```

::: {.alert .alert-success}
**Question**

1.  Do you see heterogeneity among nutrients?

    [Yes, a bit, the ranges of nutrient type vary, with 1 having the largest and 3 having the smallest.
    Nutrient 1 also seems to have a right-skewed distribution. The median of the nutrient 2, is also larger compared to the others.]{.underline}

2.  How you see (or don't) this?

    [By assessing the boxplot of concentrations for each nutrient type, I see two high values outside
    the inter-quantile range of nutrient 1. ]{.underline}
    
:::

------------------------------------------------------------------------

## Correlation vs Regression (15 min)

::: {.alert .alert-info}
**Task: Correlation vs Regression**

Compute the correlation between `concentration` and `biomass`, then fit a simple linear model and overlay the regression line.

:::
```{r}
### Compute the correlation
cor(Nereis$concentration , #concentration,
    Nereis$biomass , #biomass,
    use = "complete.obs")

### Simple regression fit:
mod_simple <- lm(concentration ~ biomass,
                 data = Nereis)
summary(mod_simple)

### Plot data + fitted line (ggplot2):
ggplot(Nereis, aes(x = biomass,
                   y = concentration)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Correlation vs Regression: line of best fit",
       x = "Biomass", y = "Concentration") +
  theme_bw()

```

::: {.alert .alert-success}
**Question**

1.  What is the difference between the correlation and regression assessment of linkages between `concentration` and `biomass`.

    [The correlation assessment tells you how the increase in one variable is reflected in the other variable and vice versa (strength and direction). 
    The regression assesses how the change in the predictor affects the response.]{.underline}
    
    
:::

## Simple linear regression (20 min)

::: {.alert .alert-info}
**Task: Simple linear regression**

Fit a model that represent ($\text{concentration} \sim \text{biomass}$) and extract the model coefficients and performance metrics.

**Hint**: Use the `summary()` function from Base R or the `tidy()` function from the `broom` package to extract the model coefficients and performance metrics.
:::

```{r}

### Build the simple regresion
mod_simple <- lm( concentration ~ biomass , data = Nereis)

### Extract the model coefficients
model_summary <- summary(mod_simple)
knitr::kable(model_summary$coefficients)
intercept <- model_summary$coefficients[1,1]
slope <- model_summary$coefficients[2,1]

### Extract the model performance metrics (R-sqr, adj-R-sqr, AIC, BIC, F-test)
R_sqr <- model_summary$r.squared
adj_R_sqr <- model_summary$adj.r.squared
AIC <- AIC(mod_simple)
BIC <- BIC(mod_simple)
F_test <- model_summary$fstatistic[1]

```

::: {.alert .alert-success}
**Question**

1.  Interpret the intercept ($\beta_0$):

    [An intercept of 1.06 indicates that at a biomass of 0, the concentration of all nutrient types will be 1.06.]{.underline}
    

2.  Interpret the slope ($\beta_{\text{biomass}}$):

    [The slope of 0.21 indicates that an increase of 1 in biomass increases the concentration of all nutrient types by 0.21.]{.underline}
    

3.  Interpret the ($p$)-value of the coefficients:

    [The p value of the intercaept indicates that the intercept is significantly different from 0 (p < 0.05).
    For the slope, the p value indicates that the slope is not different from 0.]{.underline}
    

4.  Interpret the ($p$)-value of the $F$-test:

    [This indicates that the model does not significantly explain the variation in the data.]{.underline}
    

5.  Interpret the ($R^2$): 

    [This indicates that the model explains 2% of the variation in the data.]{.underline}
    
:::

------------------------------------------------------------------------

## Multiple regression with a categorical predictor (20 min)

::: {.alert .alert-info}
**Task: Multiple regression with a categorical predictor**

Expand your original model so that it includes `nutrient` as a co-variate: ($\text{concentration} \sim \text{biomass} + \text{nutrient}$), and extract the model coefficients and performance metrics.

:::

```{r}

### Build the simple regresion
mod_multi <- lm(concentration ~ nutrient + biomass, data = Nereis)

### Get the summary of the model
summary(mod_multi)

### Extract the model coefficients
model_summary <- summary(mod_multi)
knitr::kable(model_summary$coefficients)
intercept <- model_summary$coefficients[1,1]

### Extract the model performance metrics (R-sqr, adj-R-sqr, AIC, BIC, F-test)
R_sqr <- model_summary$r.squared
adj_R_sqr <- model_summary$adj.r.squared
AIC <- AIC(mod_simple)
BIC <- BIC(mod_simple)
F_test <- model_summary$fstatistic[1]

```

::: {.alert .alert-info}
**Task: Multiple regression with a categorical predictor**


Visualize adjusted relationships (effect of biomass across nutrient levels):
:::

```{r}

### Plot the relations between concentration and biomass coulring the points and relations by nutrient
ggplot(Nereis,
       aes(x = biomass, # the contionous covariate
           y = concentration, # The resposne
           colour = nutrient # The grouping variable
           )) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Multiple regression: concentration ~ biomass + nutrient",
       x = "Biomass", y = "Concentration") +
  theme_bw()
```

::: {.alert .alert-success}
**Question**

1.  Describe in text from what the coefficients of this multiple regression describe.

    [The intercept describes the concentration of nutrient 1 at biomass 0. The slope biomass is the average effect of biomass on all nutrients.]{.underline}
    
    
2.  What is the plot representing that the model specification is no stating?

    [It represents an interaction between biomass and nutrient.]{.underline}
    
:::

## Assumptions & diagnostics in ggplot2 (20 min)

::: {.alert .alert-info}
**Task: Assumptions & diagnostics in ggplot2**

Build ggplot2 versions of standard diagnostics using

**Hint**: you can use the `broom::augment()` to add the `fitted`, `residuals`, `std.resid` to the data table.
:::

```{r}

###Crate a Dataset with fitted values, residuals, and standarzied residuals
aug <- Nereis|> mutate(.fitted = predict(mod_multi),## Add the fitted values to Nereis
                    .resid = residuals(mod_multi),## Add the residuals to Nereis
                    .std.resid= rstandard(mod_multi) ## Add the Standarized residuals to Nereis
                    )
aug

### Residuals vs fitted
ggplot(aug, aes(x = .fitted,
                y = .resid)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_point() +
  labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Residuals") +
  theme_bw()

### Scale-Location (spread vs fitted): sqrt(|standardized residuals|)
ggplot(aug, aes(x = .fitted,
                y = sqrt(abs(.std.resid)))) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(title = "Scale-Location", x = "Fitted values",
       y = expression(sqrt("|Standardized residuals|"))) +
  theme_bw()

# QQ plot (ggplot2)
qq <- augment(mod_multi,
              data = Nereis) |>
  mutate(theoretical = qqnorm(.std.resid, plot.it = FALSE)$x) |>
  mutate(sample = sort(.std.resid))

ggplot(qq, aes(x = theoretical,
               y = sample)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  labs(title = "Normal Q–Q (standardized residuals)",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_bw()
```

::: {.alert .alert-success}
**Question**

1.  Do you see non-linearity?, Why (Yes/No)?

    [From the residuals vs fitted values, there seems to be a quadratic trend of the residuals along the fitted values.
    This indicates non-linearity]{.underline}
    
    
2.  Do you see heteroscedasticity?, Why (Yes/No)?

    [The variation seems to increase with the fitted values, indicating that there is heteroscedasticity]{.underline}
    
    
3.  Strong departures from normality?, Why (Yes/No)?

    [From the qq plot, there seems to be a departure from normality, as points at the tails lies above the dotted line. The residuals are not normally distributed. ]{.underline}
:::

------------------------------------------------------------------------

## Partial residual plots in ggplot2 (20 min)

::: {.alert .alert-info}
**Task: Partial residual plots in ggplot2**

Plot ($r^{(j)}$) vs ($x_j$) with a linear smooth to visualize the adjusted relationship ￼.

**Concept**: for predictor ($x_i$), a partial residual is ($r_i^{(j)} = \hat{\varepsilon}_i + \hat{\beta}j x{ij}$).

Below is a helper that returns a tibble for a given predictor:
:::

```{r}
partial_residual_df <- function(mod, data, var){
  stopifnot(var %in% colnames(model.matrix(mod)))
  b <- coef(mod)[var]
  aug <- augment(mod, data = data)
  # For factors, var name in model.matrix includes level; handle numeric var first:
  if(!is.numeric(data[[var]]) && var %in% names(data)){
    stop("This simple helper expects a numeric predictor. For factors, see the next chunk.")
  }
  aug |>
    mutate(
      xj = data[[var]],
      partial_resid = .resid + b * xj
    )
}
```

### Partial residual for a numeric predictor: biomass

::: {.alert .alert-info}
**Task: Partial residual for a numeric predictor: biomass**

Estimate and plot the Partial residual for `biomass`.

:::

```{r}
pr_biomass <- partial_residual_df( mod_multi , # Model
                                   Nereis , #Dataset,
                                   "biomass" #Continous variable
                                  )
ggplot(pr_biomass,
       aes(x = xj, # xj,
           y = partial_resid) #partial_resid
           ) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Partial residual plot: biomass",
       x = "Biomass",
       y = expression(epsilon[i] + hat(beta)[biomass] %.% biomass[i])) +
  theme_bw()
```

## Understanding model output (15 min)

::: {.alert .alert-info}
**Task: Understanding model output**

Extract model coefficients and performance metrics from the `mod_multi` model.

**Hint**: Use `broom::tidy()` and `broom::glance()` to structure the output for interpretation:
:::

```{r}

### Build the simple regresion
mod_multi <- lm(concentration ~ nutrient + biomass, data = Nereis)

### Get the summary of the model
summary(mod_multi)

### Extract the model coefficients
model_summary <- summary(mod_multi)
knitr::kable(model_summary$coefficients)
intercept <- model_summary$coefficients[1,1]

### Extract the model performance metrics (R-sqr, adj-R-sqr, AIC, BIC, F-test)
R_sqr <- model_summary$r.squared
adj_R_sqr <- model_summary$adj.r.squared
AIC <- AIC(mod_simple)
BIC <- BIC(mod_simple)
F_test <- model_summary$fstatistic[1]
```

::: {.alert .alert-success}
**Question**

1.  Write a one line interpretation of the **Coefficients** (estimates, SEs, $t$-values, $p$-values)

    [Nutrient 2 shows a significant positive effect on the response, while nutrient3 and biomass are not statistically significant predictors.]{.underline}
    
    
2.  Write a one line interpretation of the **Goodness of fit**: $R^2$, Adjusted $R^2$, Residual SE

    [The residual std errors are still relatively large compared to the coefficients' standard errors, also reflected in the multiple and adjusted R squared, showing that the model explains relatively little of the variation of the response.]{.underline}
    
3.  Write a one line **Inference caveat**: validity hinges on assumptions (linearity, homoscedasticity, independence, normal errors)

    [Inference caveat: from the diagnostics figures, the model seems to deviate from assumptions, in that there is not linearity, homoscedasticity and normally distribuated residuals.]{.underline}
    
:::

------------------------------------------------------------------------

## Model simplification (15 min)

::: {.alert .alert-info}
**Task: Model simplification**

Try backward elimination with AIC of a model with both single and interaction effects between `biomass` and `nutrient`.

**Hint**: You can use the `step()` function to do forward, backward, or step-wise model selection - this is based on a likelihood test for the full model vs the model without a variable.
:::

```{r}

### Build a model with biomass, nutrient, and its interaction as covariates
mod_multi_full <- lm(concentration ~ nutrient * biomass,
                     data = Nereis)
### Print the summary
summary(mod_multi_full)

### Run a backward parameter selection process using the AIC criteria
mod_step <- step(mod_multi_full,
                 direction = "backward",
                 trace = 1)
#3# Print the summary
model_summary <- summary(mod_step)
model_summary

### Extract model performance of the reduced model
R_sqr <- model_summary$r.squared
adj_R_sqr <- model_summary$adj.r.squared
AIC <- AIC(mod_simple)
BIC <- BIC(mod_simple)
F_test <- model_summary$fstatistic[1]

```

::: {.alert .alert-success}
**Question**

1.  Compare coefficients and fit to `mod_multi`.

    [The coefficients of the mod_multi indicates that is a significant interaction between nutrient 2 and biomass, and both R-squared values are considerably higher compared to the model without interactions. This is with the lower AIC, indicates a better fit.]{.underline}
    
2.  Discuss potential overfitting and parsimony.

    [Increasing the number of parameters in a model will make the model fit the data better, however this could increase overfitting making it harder to generalize or make good predictions with the model. In this case however, adding the interaction term increases the adjusted R-squared and decreases the AIC, suggesting that the full model performs better.]{.underline}
    
:::

------------------------------------------------------------------------

## Uses & limitations (wrap-up, 10–15 min)

*Remember*

**Regression Analysis Strengths**: interpretability; hypothesis testing; prediction within scope. **Regression Analysis Limitations**: sensitive to assumption violations, collinearity; can miss nonlinear structure; independence often doubtful in ecology.


